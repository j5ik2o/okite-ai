# Analysis Heuristics

既存コードからドメインモデル候補を抽出するためのヒューリスティクス集。

## 集約候補の発見

### DB テーブルからの発見

| シグナル | 解釈 |
|----------|------|
| 外部キーで参照される主テーブル | 集約ルート候補 |
| 主テーブルと1:N関係の子テーブル | ローカルエンティティ候補 |
| 子テーブルが他から直接参照されない | 集約内部に閉じ込め可能 |
| 多対多の中間テーブル | 集約境界の分割ポイント |

### コードからの発見

| シグナル | 解釈 |
|----------|------|
| 同一トランザクションで常に一緒に更新されるデータ群 | 同一集約に属する |
| CRUDの単位になっているクラス/構造体 | 集約ルート候補 |
| 他のオブジェクトを経由せずに直接取得されるオブジェクト | 集約ルート候補 |
| 親オブジェクト経由でのみアクセスされるオブジェクト | ローカルエンティティ/値オブジェクト候補 |

### ビジネスルールからの発見

| シグナル | 解釈 |
|----------|------|
| 「〜は必ず〜と一緒に存在する」 | 同一集約 |
| 「〜が変わっても〜には影響しない」 | 別の集約 |
| 「〜の数は最大N個まで」 | 集約内の不変条件 |

## 値オブジェクト候補の発見

| シグナル | 解釈 |
|----------|------|
| プリミティブ型（string, int）で表現されたドメイン概念 | 値オブジェクト候補 |
| 同じ検証ロジックが複数箇所に散在 | 値オブジェクトで集約すべき |
| 複数フィールドが常にセットで使われる | 複合値オブジェクト候補 |
| 金額・日付範囲・住所・メールアドレス等 | 典型的な値オブジェクト |
| enum/定数で表現された状態・種別 | 値オブジェクト or enum候補 |
| IDとして使われるフィールド | ID値オブジェクト候補 |

## ローカルエンティティ候補の発見

| シグナル | 解釈 |
|----------|------|
| 親テーブルの子レコードで、独自のIDを持つ | ローカルエンティティ |
| コレクション内で個別に識別する必要がある | ローカルエンティティ |
| 親なしでは存在意味がない | 集約内ローカルエンティティ |

## ドメインサービス候補の発見

| シグナル | 解釈 |
|----------|------|
| 2つ以上のエンティティ/集約にまたがる操作 | ドメインサービス候補 |
| 特定のオブジェクトに属さないビジネスルール | ドメインサービス候補 |
| 外部システムとの連携を抽象化する操作 | ドメインサービス候補 |
| 「〜ポリシー」「〜仕様」と表現できるルール | 仕様/ポリシーオブジェクト候補 |

## 非DDDコードの典型パターンとマッピング

| 既存コードのパターン | DDDでの対応 |
|----------------------|-------------|
| 巨大なServiceクラス | 集約のメソッド + ドメインサービスに分解 |
| Util/Helperクラス | 値オブジェクトのメソッド or ドメインサービス |
| DTOにビジネスロジック | 集約/エンティティに移動 |
| Controller内のバリデーション | 値オブジェクトの生成時検証に移動 |
| if分岐の多い手続き的コード | ポリモーフィズム or 仕様パターン |
| グローバル定数・マジックナンバー | 値オブジェクト or enum |
| 複数テーブルへの同時書き込み | 集約の特定 → 整合性境界の明確化 |
