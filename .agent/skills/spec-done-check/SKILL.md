---
name: spec-done-check
description: >-
  制約カードに対する実装完了検証スキル。`.constraints/<name>.md`の制約カードを読み込み、
  制約(MUST)の充足、非目標(NOT)への非逸脱、受入テストのPass/Failを検証する。
  重厚なバリデーションレポートではなく、簡潔なPass/Failリストを出力する。
  spec-constraint-cardスキルで作成した制約カードの検証に使用する。
  トリガー：「完了確認」「done check」「制約を満たしたか」「制約カードの検証」
  「実装が終わったか確認」「完了チェック」といった実装完了の検証リクエストで起動。
  kiroワークフロー（/kiro:validate-impl）を使う場合はこのスキルは不要。
---

# 完了検証（Done Check）

制約カードに対して、実装が完了しているかをPass/Failで判定する。

## 核心原則

**検証は簡潔に。散文のレポートではなく、制約ごとのPass/Fail。**

## 手順

### 1. 制約カードの読み込み

引数またはユーザー指示から対象の制約カードを特定する。

```
/spec-done-check jwt-authentication
→ .constraints/jwt-authentication.md を読み込む
```

引数がない場合は `.constraints/` 内の `status: active` のカード一覧を表示し、ユーザーに選択を求める。

ステータス確認:
- `status: active` → 検証対象
- `status: done` → スキップ（「既に完了済みです」と表示）
- `status: draft` → スキップ（「まだ下書きです。activeにしてください」と表示）

`.constraints/` ディレクトリが存在しない場合:
```
⚠ .constraints/ ディレクトリが見つかりません。
  /spec-constraint-card で制約カードを作成してください。
```

### 2. 制約(MUST)の検証

制約カードの各MUST項目を1つずつ検証する。

検証手段（上から順に試行）:
1. **テストの存在と結果**: 対応するテストがあれば実行結果を確認
2. **コードの静的確認**: 実装コードを読んで制約が満たされているか確認
3. **差分の確認**: git diffで変更内容が制約に整合するか確認

### 3. 非目標(NOT)の検証

制約カードの各NOT項目について、実装が逸脱していないか確認する。

検証手段:
1. **差分の確認**: 変更ファイル・変更内容がNOT項目に触れていないか
2. **新規ファイルの確認**: NOT項目に関連するファイルが新規作成されていないか

### 4. 受入テストの検証

受入テストの各項目を検証する。

検証手段:
1. **テストコードの存在確認**: 受入テストに対応するテストが実装されているか
2. **テスト実行**: テストが実行可能なら実行し結果を確認
3. **手動確認**: 自動テストが不可能な場合は、コードレベルで確認

### 5. 結果の出力

以下の形式で出力する。

```
## 完了検証: <制約カード名>

### 制約 (MUST)
- [PASS] 既存の認証インターフェースを破壊しない
- [PASS] トークン有効期限は設定可能（デフォルト1h）
- [FAIL] 認証失敗時は401を返す → 現在403を返している

### 非目標 (NOT)
- [OK] OAuth2対応 → 触れていない
- [OK] リフレッシュトークン → 触れていない
- [WARN] セッション管理 → session.tsに変更あり（要確認）

### 受入テスト
- [PASS] 有効なJWTでGET /api/usersが200を返す
- [PASS] 期限切れJWTで401が返る
- [FAIL] 不正な署名のJWTで401が返る → テスト未実装
- [PASS] JWTなしでのアクセスで401が返る

### 判定: FAIL（未達2件）
- 認証失敗時のステータスコードを401に修正
- 不正署名JWTのテストを追加
```

### 6. ステータスの自動更新

判定が **PASS** の場合、制約カードの `status` を自動更新する。

```yaml
# before
status: active

# after（PASS時に自動更新）
status: done
```

- PASS → `status: done` に更新
- PASS（要確認） → 更新しない（WARNの確認を待つ）
- FAIL → 更新しない

## 判定ルール

| 状態 | 判定 |
|------|------|
| 全MUST PASS + 全NOT OK + 全テスト PASS | **PASS** |
| FAIL が1つでもある | **FAIL**（未達リストを表示） |
| WARN がある（FAILなし） | **PASS（要確認）**（WARN項目を表示） |

### WARNの判定基準

NOT項目に対する変更が以下に該当する場合 **WARN** とする:

- NOT項目と同名のファイルを変更しているが、変更内容がインポート整理・フォーマットのみ
- NOT項目に関連するキーワードが差分に含まれるが、コメントや文字列リテラル内のみ
- NOT項目に隣接するコードを変更しているが、NOT項目自体の実装ではない

以下の場合は **OK** とする（WARNにしない）:
- NOT項目と無関係なファイルの変更
- NOT項目のキーワードが一切差分に含まれない

## 出力のルール

- 各項目は1行で完結させる
- FAILには理由を `→` の後に簡潔に記載
- 散文での説明や改善提案は書かない（聞かれたら別途回答）
- 判定結果の末尾に未達項目のリストを箇条書き

## 関連スキル

- **spec-constraint-card**: 制約カードの作成
- **spec-scope-guard**: 実装中のスコープ逸脱検出
